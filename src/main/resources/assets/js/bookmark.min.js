"use strict";function main(){if(window.addEventListener("hashchange",function(e){var t=e.newURL.split("main#/")[1].split("/")[0];updateBookmarkTree("com.enonic.cms.".concat(t)),disableHeaderButtons()}),window.location.hash.includes("widget/bookmark/bookmark-list")){var e=document.getElementById("bookmark__top-menu"),t=document.querySelectorAll("[data-content-id]");if(!e)return;if(!t)return;addGetChildrenEventListener(),checkBoxEventListener(),addRemoveBookmarkEventListener(),addPriorityBookmarkEventListener(),addRefreshTreeEventListener(),addUploadLicenseListener(e)}else{var n=document.getElementById("bookmark__context-panel"),r=document.querySelector('[data-id="favorite-content-button"]'),o=document.querySelector('[data-id="unfavorite-content-button"]'),i=document.querySelector('[data-id="set-priority-button"]'),a=n.getAttribute("data-content-id"),c=n.getAttribute("data-bookmark-service-url");if(addUploadLicenseListener(n),!c)return;r&&r.addEventListener("click",function(){r.setAttribute("disabled",!0),fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"favorite",contentId:a})}).then(function(e){return e.json()}).then(function(e){r.removeAttribute("disabled"),e&&e._id?(updateBookmarkTree(),r.style.display="none",o.style.display="block",i.style.display="block",i.classList.remove("selected")):n.insertAdjacentHTML("beforeend",'<p class="bookmark__context-panel__error">It was not possible to bookmark this content</p>')})}),o&&o.addEventListener("click",function(){o.setAttribute("disabled",!0),fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"unfavorite",contentId:a})}).then(function(e){return e.json()}).then(function(e){o.removeAttribute("disabled"),e&&e._id?(updateBookmarkTree(),o.style.display="none",r.style.display="block",i.style.display="none"):n.insertAdjacentHTML("beforeend",'<p class="bookmark__context-panel__error">It was not possible to remove the bookmark</p>')})}),handlePriorityButtonListener({contentId:a,bookmarkServiceURL:c,bookmarkContextPanelElement:n})}}function addGetChildrenEventListener(){var e=document.getElementById("bookmark__top-menu"),t=e.getAttribute("data-bookmark-service-url"),n=e.getAttribute("data-repository-id"),r=e.getAttribute("data-branch"),o=document.querySelectorAll("[data-content-id].expandable");o.length&&o.forEach(function(e){e.classList.contains("expandable")&&e.addEventListener("click",function(){return getChildrenEventListener({bookmarkServiceURL:t,branch:r,repositoryId:n,item:e})})})}function addPriorityBookmarkEventListener(){var e=document.querySelector('[data-id="deprioritizeSelected"]'),t=document.querySelector('[data-id="prioritizeSelected"]'),n=document.getElementById("bookmark__top-menu").getAttribute("data-bookmark-service-url");e&&e.addEventListener("click",function(){var e=document.querySelectorAll(".item-wrapper label.checked");if(e.length){var t=[];e.forEach(function(e){e.nextElementSibling.nextElementSibling.classList.contains("priority")&&t.push(e.getAttribute("id"))}),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"remove_priority",contentIds:t})}).then(function(e){return e.json()}).then(function(e){e&&e._id&&(updateBookmarkTree(),disableHeaderButtons())})}}),t&&t.addEventListener("click",function(){var e=document.querySelectorAll(".item-wrapper label.checked");if(e.length){var t=[];e.forEach(function(e){e.nextElementSibling.nextElementSibling.classList.contains("priority")||t.push(e.getAttribute("id"))}),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"add_priority",contentIds:t})}).then(function(e){return e.json()}).then(function(e){e&&e._id&&(updateBookmarkTree(),disableHeaderButtons())})}})}function addRefreshTreeEventListener(){var e=document.getElementById("refreshContent");e&&e.addEventListener("click",function(){var e=window.location.href.split("main#/")[1].split("/")[0];updateBookmarkTree("com.enonic.cms.".concat(e)),disableHeaderButtons()})}function addRemoveBookmarkEventListener(){var e=document.getElementById("removeSelection"),t=document.getElementById("bookmark__top-menu").getAttribute("data-bookmark-service-url");e&&e.addEventListener("click",function(){var e=document.querySelectorAll(".item-wrapper label.checked"),n=[];e.length&&(e.forEach(function(e){return n.push(e.getAttribute("id"))}),fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"unfavorite",contentIds:n})}).then(function(e){return e.json()}).then(function(t){t&&t._id&&(e.forEach(function(e){n.some(function(t){return t===e.getAttribute("id")})&&e.closest(".item").remove()}),disableHeaderButtons())}))})}function addUploadLicenseListener(e){var t=e.querySelector("#bookmark_upload_input");t&&(t.addEventListener("click",function(){this.querySelector("input").click()},!1),t.querySelector("input").addEventListener("change",function(e){var t=this.getAttribute("data-license-service-url"),n=e.target.files[0];if(n){var r=new FormData;r.append("license",n),fetch(t,{method:"POST",body:r}).then(function(e){e.ok?(document.querySelector(".bookmark_license .error-message").style.display="none",reloadWidget()):document.querySelector(".bookmark_license .error-message").style.display="block"}).catch(function(){document.querySelector(".bookmark_license .error-message").style.display="none"})}}))}function updateBookmarkTree(e){var t=document.getElementById("bookmark__top-menu");if(t){var n=t.getAttribute("data-bookmark-service-url"),r=e||t.getAttribute("data-repository-id");t.setAttribute("data-repository-id",r);var o=t.getAttribute("data-branch");fetch(n+"?repositoryId=".concat(r,"&branch=").concat(o,"&action=get-all")).then(function(e){return e.json()}).then(function(e){var t=document.querySelector(".bookmark-list");if(t){t.innerHTML="";var n=buildBookmarkTree({data:e,reset:!0});t.insertAdjacentElement("beforeend",n)}}).then(function(){return checkBoxEventListener()})}}function checkBoxEventListener(){var e=document.querySelectorAll(".item-wrapper label"),t=document.querySelector("#checkAll"),n=document.querySelector("#removeSelection"),r=document.querySelector('[data-id="deprioritizeSelected"]'),o=document.querySelector('[data-id="prioritizeSelected"]');function i(){e=document.querySelectorAll(".item-wrapper label");var t={checked:0,checkedPriority:0,checkedNoPriority:0};e.forEach(function(e){var n=e.nextElementSibling.nextElementSibling,r=e.classList.contains("checked"),o=n.classList.contains("priority");r&&(t.checked++,o?t.checkedPriority++:t.checkedNoPriority++)}),t.checked>0?toggleDisableElement({element:n,disable:!1}):toggleDisableElement({element:n,disable:!0}),0===t.checked?(toggleDisableElement({element:r,disable:!0}),toggleDisableElement({element:o,disable:!0})):(t.checkedPriority>0?toggleDisableElement({element:r,disable:!1}):toggleDisableElement({element:r,disable:!0}),t.checkedNoPriority>0?toggleDisableElement({element:o,disable:!1}):toggleDisableElement({element:o,disable:!0}))}e.forEach(function(e){"true"!==e.getAttribute("listener")&&e.addEventListener("click",function(n){n.preventDefault(),e.setAttribute("listener","true"),t.classList.contains("checked")&&e.classList.contains("checked")&&t.classList.remove("checked"),e.classList.toggle("checked"),i()})}),t&&"true"!==t.getAttribute("listener")&&(t.setAttribute("listener","true"),t.addEventListener("click",function(r){r.preventDefault(),e=document.querySelectorAll(".item-wrapper label"),t.classList.contains("checked")?(t.classList.remove("checked"),e.forEach(function(e){e.classList.contains("checked")&&e.classList.remove("checked")})):(t.classList.add("checked"),e.forEach(function(e){e.classList.contains("checked")||e.classList.add("checked")}),n.classList.remove("disabled")),i()}))}function toggleDisableElement(e){if(e.element){if(e.disable)return e.element.classList.add("disabled"),void e.element.setAttribute("disabled","");e.element.classList.remove("disabled"),e.element.removeAttribute("disabled")}}function handlePriorityButtonListener(e){var t=e.contentId,n=e.bookmarkServiceURL,r=e.bookmarkContextPanelElement,o=document.querySelector('[data-id="set-priority-button"]'),i=document.querySelector(".priority-tooltip");"true"!==o.getAttribute("listener")&&(o.addEventListener("click",function(){r.querySelector(".bookmark__context-panel__error")&&r.querySelector(".bookmark__context-panel__error").remove(),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"toggle_priority",contentId:t})}).then(function(e){return e.json()}).then(function(e){o.removeAttribute("disabled"),e&&e._id?(updateBookmarkTree(),o.classList.contains("selected")?i.innerHTML=i.getAttribute("data-add-priority-text"):i.innerHTML=i.getAttribute("data-remove-priority-text"),o.classList.toggle("selected")):r.insertAdjacentHTML("beforeend",'<p class="bookmark__context-panel__error">It was not possible to remove priority from this content</p>')})}),o.setAttribute("listener","true"))}function getChildrenEventListener(e){var t=e.bookmarkServiceURL,n=e.branch,r=e.repositoryId,o=e.item,i=o.getAttribute("data-content-id");o.classList.contains("expanded")?(o.classList.remove("expanded"),o.parentElement.parentElement.querySelector(".bookmark-sublist").remove()):fetch(t+"?contentId=".concat(i,"&repositoryId=").concat(r,"&branch=").concat(n,"&action=get-children")).then(function(e){return e.json()}).then(function(e){var t=buildBookmarkTree({data:e});o.parentElement.parentElement.insertAdjacentElement("beforeend",t),o.classList.add("expanded")})}function buildBookmarkTree(e){var t=e.data,n=e.reset,r=void 0!==n&&n,o=document.getElementById("bookmark__top-menu"),i=o.getAttribute("data-bookmark-service-url"),a=o.getAttribute("data-repository-id"),c=o.getAttribute("data-branch"),d=document.createElement("div");return r||d.classList.add("bookmark-sublist"),t.forEach(function(e){var t=document.createElement("div");t.classList.add("item");var n=document.createElement("div");n.classList.add("item-wrapper"),t.appendChild(n);var o=document.createElement("div");o.classList.add("toggle","icon","expand"),e.hasChildren&&(o.setAttribute("data-content-id",e._id),o.classList.add("expandable"),o.addEventListener("click",function(){return getChildrenEventListener({bookmarkServiceURL:i,branch:c,repositoryId:a,item:o})}));var l=document.createElement("a");if(l.href=e.link,l.target="_blank",l.classList.add("item-info"),e.isPriority&&l.classList.add("priority"),r){var s=document.createElement("label");s.id=e._id;var u=document.createElement("input");u.type="checkbox",s.appendChild(u),n.appendChild(s)}n.appendChild(o),n.appendChild(l);var m=document.createElement("img");m.src=e.icon,m.width=32,m.height=32;var b=document.createElement("div");b.classList.add("content-info"),l.appendChild(m),l.appendChild(b);var k=document.createElement("strong");k.textContent=e.displayName;var p=document.createElement("p");p.textContent=e._path,b.appendChild(k),b.appendChild(p),d.appendChild(t)}),d}function reloadWidget(){var e=document.querySelector("#app-bookmark-list"),t=e&&e.getAttribute("data-widget-url");t&&fetch(t,{method:"GET"}).then(function(e){return e.text()}).then(function(t){t&&(e.outerHTML=t,main())}).catch(function(e){return console.log(e)});var n=document.querySelector("#app-bookmark"),r=n&&n.getAttribute("data-widget-url");r&&fetch(r,{method:"GET"}).then(function(e){return e.text()}).then(function(e){e&&(n.parentElement.innerHTML=e,main())})}function disableHeaderButtons(){var e=document.getElementById("removeSelection"),t=document.querySelector('[data-id="deprioritizeSelected"]'),n=document.querySelector('[data-id="prioritizeSelected"]');document.getElementById("checkAll").classList.remove("checked"),toggleDisableElement({element:e,disable:!0}),toggleDisableElement({element:t,disable:!0}),toggleDisableElement({element:n,disable:!0})}main();